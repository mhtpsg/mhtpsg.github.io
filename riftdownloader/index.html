<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NinjaRift SWF Downloader</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .control-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            min-width: 150px;
        }

        .btn-start {
            background: #10b981;
            color: white;
        }

        .btn-start:hover:not(:disabled) {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .btn-stop {
            background: #ef4444;
            color: white;
        }

        .btn-stop:hover:not(:disabled) {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
        }

        .btn-download {
            background: #3b82f6;
            color: white;
        }

        .btn-download:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
        }

        .progress-section {
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #e5e7eb;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .log-container {
            background: #1f2937;
            color: #10b981;
            padding: 20px;
            border-radius: 10px;
            height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 4px;
        }

        .log-success {
            color: #10b981;
        }

        .log-error {
            color: #ef4444;
        }

        .log-info {
            color: #3b82f6;
        }

        .log-warning {
            color: #f59e0b;
        }

        .folder-progress {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .folder-name {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }

        .folder-stats {
            font-size: 14px;
            color: #6b7280;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .downloading {
            animation: pulse 2s infinite;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .status-ready {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-downloading {
            background: #dcfce7;
            color: #166534;
        }

        .status-stopped {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-completed {
            background: #fef3c7;
            color: #92400e;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #374151;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: #10b981;
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #059669;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü•∑ NinjaRift SWF Downloader</h1>
            <p>Download semua file SWF dari NinjaRift.org</p>
        </div>

        <div class="content">
            <div class="control-panel">
                <div id="statusBadge" class="status-badge status-ready">
                    ‚è≥ Siap untuk mulai
                </div>
                <div class="button-group">
                    <button id="startBtn" class="btn-start" onclick="startDownload()">
                        ‚ñ∂Ô∏è Mulai Download
                    </button>
                    <button id="stopBtn" class="btn-stop" onclick="stopDownload()" disabled>
                        ‚èπÔ∏è Stop Download
                    </button>
                    <button id="downloadZipBtn" class="btn-download" onclick="downloadZip()" disabled>
                        üì¶ Download ZIP
                    </button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <h3>Total File</h3>
                    <div class="value" id="totalFiles">0</div>
                </div>
                <div class="stat-card">
                    <h3>Berhasil</h3>
                    <div class="value" id="successFiles">0</div>
                </div>
                <div class="stat-card">
                    <h3>Gagal</h3>
                    <div class="value" id="failedFiles">0</div>
                </div>
                <div class="stat-card">
                    <h3>Ukuran Total</h3>
                    <div class="value" id="totalSize">0 MB</div>
                </div>
            </div>

            <div class="progress-section">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar">0%</div>
                </div>
                <div id="currentFolder" class="folder-progress" style="display: none;">
                    <div class="folder-name">üìÅ <span id="folderName">-</span></div>
                    <div class="folder-stats">
                        File: <span id="folderFileCount">0</span> | 
                        Progress: <span id="folderProgress">0</span>/<span id="folderTotal">0</span>
                    </div>
                </div>
            </div>

            <div class="log-container" id="logContainer">
                <div class="log-entry log-info">üöÄ Sistem siap. Klik "Mulai Download" untuk memulai...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Global variables
        let downloadedFiles = [];
        let totalDownloaded = 0;
        let totalFailed = 0;
        let totalSize = 0;
        let isDownloading = false;
        let shouldStop = false;
        const BASE_URL = 'https://ninjarift.org/swf/';
        
        const folders = [
            { name: 'enemy', pattern: 'ene_{:02d}.swf', start: 1 },
            { name: 'essentials', pattern: 'essential_{:02d}.swf', start: 1 },
            { name: 'items', patterns: [
                { type: 'accessory', pattern: 'accessory_{:02d}.swf', start: 1 },
                { type: 'back', pattern: 'back_{:02d}.swf', start: 0 },
                { type: 'face', pattern: 'face_{:02d}_{}.swf', start: 1, suffixes: ['0', '1'] },
                { type: 'hair', pattern: 'hair_{:02d}_{}.swf', start: 1, suffixes: ['0', '1'] },
                { type: 'logo', pattern: 'logo_{:02d}.swf', start: 1 },
                { type: 'set', pattern: 'set_{:02d}_{}.swf', start: 1, suffixes: ['0', '1'] },
                { type: 'wpn', pattern: 'wpn_{:02d}.swf', start: 1 }
            ]},
            { name: 'materials', pattern: 'material_{:02d}.swf', start: 1 },
            { name: 'mission', pattern: 'mission_{:02d}.swf', start: 1 },
            { name: 'npcs', pattern: 'npc_{}.swf', start: 1, noZero: true },
            { name: 'pets', pattern: 'pet_', dynamic: true },
            { name: 'scrolls', pattern: 'item_{:02d}.swf', start: 1 },
            { name: 'skills', pattern: 'skill_{:02d}.swf', start: 1 },
            { name: 'swfpanels', pattern: '.swf', dynamic: true }
        ];

        // Service Worker untuk background download
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                self.addEventListener('install', (event) => {
                    self.skipWaiting();
                });
                
                self.addEventListener('activate', (event) => {
                    event.waitUntil(clients.claim());
                });
            `)).then(() => {
                log('‚úÖ Service Worker registered for background download', 'success');
            });
        }

        // Request notification permission
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }

        // Helper functions
        function padZero(num, len = 2) {
            return String(num).padStart(len, '0');
        }

        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            
            const timestamp = new Date().toLocaleTimeString('id-ID');
            const icon = {
                'success': '‚úì',
                'error': '‚úó',
                'info': '‚Ñπ',
                'warning': '‚ö†'
            }[type] || '‚Ñπ';
            
            entry.textContent = `[${timestamp}] ${icon} ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateStats() {
            document.getElementById('totalFiles').textContent = totalDownloaded + totalFailed;
            document.getElementById('successFiles').textContent = totalDownloaded;
            document.getElementById('failedFiles').textContent = totalFailed;
            document.getElementById('totalSize').textContent = (totalSize / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function updateProgress(current, total) {
            const percentage = total > 0 ? Math.round((current / total) * 100) : 0;
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = percentage + '%';
        }

        function updateFolderInfo(folderName, fileCount, current, total) {
            document.getElementById('currentFolder').style.display = 'block';
            document.getElementById('folderName').textContent = folderName;
            document.getElementById('folderFileCount').textContent = fileCount;
            document.getElementById('folderProgress').textContent = current;
            document.getElementById('folderTotal').textContent = total;
        }

        function setStatus(status, text) {
            const badge = document.getElementById('statusBadge');
            badge.className = `status-badge status-${status}`;
            badge.textContent = text;
        }

        async function checkFileExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD', mode: 'no-cors' });
                return true; // Karena no-cors, kita assume file ada
            } catch {
                return false;
            }
        }

        async function downloadFile(url, filename, folderName) {
            try {
                const proxyUrl = url; // Jika ada CORS issue, gunakan proxy
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error('File not found');
                }
                
                const blob = await response.blob();
                totalSize += blob.size;
                
                downloadedFiles.push({
                    folder: folderName,
                    filename: filename,
                    blob: blob,
                    size: blob.size
                });
                
                totalDownloaded++;
                log(`Downloaded: ${folderName}/${filename} (${(blob.size / 1024).toFixed(2)} KB)`, 'success');
                updateStats();
                
                return true;
            } catch (error) {
                totalFailed++;
                log(`Failed: ${folderName}/${filename}`, 'error');
                updateStats();
                return false;
            }
        }

        async function downloadFolder(folderConfig) {
            if (shouldStop) return 0;
            
            const folderName = folderConfig.name;
            const folderUrl = BASE_URL + folderName + '/';
            let downloaded = 0;
            
            log(`üìÅ Processing folder: ${folderName}`, 'info');
            setStatus('downloading', `‚è¨ Downloading ${folderName}...`);
            
            if (folderConfig.patterns) {
                // Complex folder with multiple patterns (items)
                for (const pattern of folderConfig.patterns) {
                    if (shouldStop) break;
                    
                    log(`  ‚Üí Processing ${pattern.type} files...`, 'info');
                    let consecutiveMissing = 0;
                    let i = pattern.start;
                    
                    while (consecutiveMissing < 50 && !shouldStop) {
                        if (pattern.suffixes) {
                            for (const suffix of pattern.suffixes) {
                                if (shouldStop) break;
                                
                                const filename = pattern.pattern
                                    .replace('{:02d}', padZero(i))
                                    .replace('{}', suffix);
                                const fileUrl = folderUrl + filename;
                                
                                updateFolderInfo(folderName, downloaded, i, '?');
                                
                                const success = await downloadFile(fileUrl, filename, folderName);
                                if (success) {
                                    downloaded++;
                                    consecutiveMissing = 0;
                                } else {
                                    consecutiveMissing++;
                                }
                                
                                await new Promise(resolve => setTimeout(resolve, 50));
                            }
                        } else {
                            const filename = pattern.noZero 
                                ? pattern.pattern.replace('{}', i)
                                : pattern.pattern.replace('{:02d}', padZero(i));
                            const fileUrl = folderUrl + filename;
                            
                            updateFolderInfo(folderName, downloaded, i, '?');
                            
                            const success = await downloadFile(fileUrl, filename, folderName);
                            if (success) {
                                downloaded++;
                                consecutiveMissing = 0;
                            } else {
                                consecutiveMissing++;
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                        i++;
                    }
                }
            } else if (folderConfig.dynamic) {
                // Dynamic folder - get file list first
                log(`  ‚Üí Fetching file list from ${folderName}...`, 'info');
                // Untuk demo, kita skip dynamic folders karena CORS
                log(`  ‚ö† Skipping dynamic folder ${folderName} (CORS limitation)`, 'warning');
            } else {
                // Simple sequential pattern
                let consecutiveMissing = 0;
                let i = folderConfig.start;
                
                while (consecutiveMissing < 50 && !shouldStop) {
                    const filename = folderConfig.noZero 
                        ? folderConfig.pattern.replace('{}', i)
                        : folderConfig.pattern.replace('{:02d}', padZero(i));
                    const fileUrl = folderUrl + filename;
                    
                    updateFolderInfo(folderName, downloaded, i, '?');
                    
                    const success = await downloadFile(fileUrl, filename, folderName);
                    if (success) {
                        downloaded++;
                        consecutiveMissing = 0;
                    } else {
                        consecutiveMissing++;
                    }
                    
                    i++;
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
            
            log(`üìä Downloaded ${downloaded} files from ${folderName}`, 'info');
            return downloaded;
        }

        async function startDownload() {
            if (isDownloading) return;
            
            isDownloading = true;
            shouldStop = false;
            downloadedFiles = [];
            totalDownloaded = 0;
            totalFailed = 0;
            totalSize = 0;
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('downloadZipBtn').disabled = true;
            
            setStatus('downloading', '‚è¨ Downloading...');
            log('üöÄ Starting download process...', 'info');
            
            // Wake lock untuk mencegah sleep
            let wakeLock = null;
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    log('üîí Wake lock acquired', 'info');
                } catch (err) {
                    log('‚ö† Could not acquire wake lock', 'warning');
                }
            }
            
            try {
                for (let i = 0; i < folders.length; i++) {
                    if (shouldStop) break;
                    
                    await downloadFolder(folders[i]);
                    updateProgress(i + 1, folders.length);
                    
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (!shouldStop) {
                    log('üéâ All downloads completed!', 'success');
                    log(`üìä Total files downloaded: ${totalDownloaded}`, 'info');
                    setStatus('completed', '‚úÖ Download Selesai!');
                    
                    // Show notification
                    if ('Notification' in window && Notification.permission === 'granted') {
                        new Notification('Download Selesai! üéâ', {
                            body: `${totalDownloaded} file berhasil didownload. Total: ${(totalSize / (1024 * 1024)).toFixed(2)} MB`,
                            icon: 'ü•∑',
                            requireInteraction: true
                        });
                    }
                    
                    document.getElementById('downloadZipBtn').disabled = false;
                }
                
            } catch (error) {
                log(`‚ùå Error: ${error.message}`, 'error');
                setStatus('stopped', '‚ùå Error');
            } finally {
                isDownloading = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                
                if (wakeLock) {
                    wakeLock.release();
                    log('üîì Wake lock released', 'info');
                }
            }
        }

        function stopDownload() {
            shouldStop = true;
            log('‚ö† Stopping download...', 'warning');
            setStatus('stopped', '‚èπÔ∏è Stopped');
            
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('startBtn').disabled = false;
            
            if (downloadedFiles.length > 0) {
                document.getElementById('downloadZipBtn').disabled = false;
            }
        }

        async function downloadZip() {
            if (downloadedFiles.length === 0) {
                log('‚ùå No files to zip', 'error');
                return;
            }
            
            log('üì¶ Creating ZIP archive...', 'info');
            setStatus('downloading', 'üì¶ Creating ZIP...');
            
            const zip = new JSZip();
            
            // Add files to zip
            for (const file of downloadedFiles) {
                const folderPath = file.folder + '/';
                zip.file(folderPath + file.filename, file.blob);
            }
            
            log(`  ‚Üí Added ${downloadedFiles.length} files to ZIP`, 'info');
            
            // Generate zip
            try {
                const content = await zip.generateAsync({
                    type: 'blob',
                    compression: 'DEFLATE',
                    compressionOptions: { level: 6 }
                }, (metadata) => {
                    const percent = metadata.percent.toFixed(0);
                    log(`  ‚Üí Compressing: ${percent}%`, 'info');
                });
                
                // Download zip
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
                const filename = `NinjaRift_SWF_Files_${timestamp}.zip`;
                
                const a = document.createElement('a');
                a.href = URL.createObjectURL(content);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                
                const zipSizeMB = (content.size / (1024 * 1024)).toFixed(2);
                log(`‚úÖ ZIP archive created successfully!`, 'success');
                log(`üìÑ Total files: ${downloadedFiles.length}`, 'info');
                log(`üìä ZIP size: ${zipSizeMB} MB`, 'info');
                log(`üìç ZIP name: ${filename}`, 'info');
                
                setStatus('completed', '‚úÖ ZIP Ready!');
                
                // Show notification
                if ('Notification' in window && Notification.permission === 'granted') {
                    new Notification('ZIP Created! üì¶', {
                        body: `${filename} (${zipSizeMB} MB) siap didownload!`,
                        icon: 'ü•∑',
                        requireInteraction: true
                    });
                }
                
            } catch (error) {
                log(`‚ùå Error creating ZIP: ${error.message}`, 'error');
                setStatus('stopped', '‚ùå ZIP Error');
            }
        }

        // Prevent page unload during download
        window.addEventListener('beforeunload', (e) => {
            if (isDownloading) {
                e.preventDefault();
                e.returnValue = 'Download masih berjalan. Yakin ingin keluar?';
                return e.returnValue;
            }
        });

        // Log when page is hidden/visible
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isDownloading) {
                log('üì± App in background - download continues...', 'info');
            } else if (!document.hidden && isDownloading) {
                log('üì± App back to foreground', 'info');
            }
        });
    </script>
</body>
</html>
